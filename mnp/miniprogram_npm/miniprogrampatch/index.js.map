{"version":3,"sources":["miniprogrampatch.js"],"names":[],"mappings":";;;;;;;AAAA;AACA","file":"index.js","sourcesContent":["// miniprogrampatch v1.3.0 Mon May 25 2020  \n!function(t,e){\"object\"==typeof exports&&\"object\"==typeof module?module.exports=e():\"function\"==typeof define&&define.amd?define([],e):\"object\"==typeof exports?exports.miniprogrampatch=e():t.miniprogrampatch=e()}(\"undefined\"!=typeof self?self:this,function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(t,\"__esModule\",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&\"object\"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,\"default\",{enumerable:!0,value:t}),2&e&&\"string\"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,\"a\",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p=\"\",n(n.s=0)}([function(t,e,n){var r=n(1),i=n(9),a=n(10);t.exports={patchComponent:i.patchComponent,patchOnShareAppMessage:a.patchOnShareAppMessage,patchPage:r.patchPage,patchRouterPage:a.patchRouterPage}},function(t,e,n){e.__esModule=!0,e.patchPage=function(t,e){if(t.__patchPage)return t;var n=!1,u=(e||{}).debug,s=function(e){var s=e=Object.assign({},e),c=s.onLoad,h=s.watch,f=s.computed;return e.onLoad=function(t){if(!this.$setData){this.__setData=this.setData,this.$setData=this.updateData=function(t,e){return(0,i.default)(t,e,{ctx:this})},(0,r.constructComputedFeature)(this,f);var e=(0,r.calculateInitialComputedValues)(this);e&&this.__setData(e),(0,o.constructWatchFeature)(this,h||{},this.data);try{n||(this.setData=this.$setData)}catch(t){n=!0,u&&(console.log(t),console.log(\"using this.$setData instead of this.setData to support watch and computed features.\"))}}(0,a.isFunction)(c)&&c.call(this,t)},t(e)};return s.__patchPage=!0,s};var r=n(2),i=function(t){return t&&t.__esModule?t:{default:t}}(n(7)),a=n(6),o=n(8)},function(t,e,n){e.__esModule=!0,e.isPropPath=e.evaluateComputedResult=e.constructComputedFeature=e.calculateInitialComputedValues=void 0;var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,\"value\"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),i=n(3),a=c(i),o=n(5),u=c(n(4)),s=n(6);function c(t){return t&&t.__esModule?t:{default:t}}var h=1e5,f=function(t){return!t._evaluating&&t.addToQueue()},l=function(){function t(e,n,r,i,o){!function(t,e){if(!(t instanceof e))throw new TypeError(\"Cannot call a class as a function\")}(this,t),this.owner=e,this.name=n,this.required=r||[],this.fn=i,this.keen=!!o,this.oldVal=this.newVal=void 0;var u=(0,a.default)(n);this.rootPath=u[0].key,this.isRootObserver=1===u.length,this.observers=[],this.watchings=[],this.children=[],this.keenObservers=[],this.evalTimes=0,this.everEvaluated=!1}return t.prototype.addChildObserver=function(t){this.children.findIndex(function(e){return e===t})<0&&this.children.push(t)},t.prototype.addDirtyObserver=function(t){this.keenObservers.findIndex(function(e){return e===t})<0&&this.keenObservers.push(t)},t.prototype.addObserver=function(t){this.observers.findIndex(function(e){return e===t})<0&&this.observers.push(t)},t.prototype.addToQueue=function(){var t=this,e=this.owner.__computingQueue;e.findIndex(function(e){return e===t})<0&&e.push(this)},t.prototype.addWatching=function(t){this.watchings.findIndex(function(e){return e===t})<0&&this.watchings.push(t)},t.prototype.checkDirty=function(){this.dirty?(this.newVal=this.getTempResult().value,this.observers.forEach(f)):this.keenObservers.forEach(f)},t.prototype.clean=function(){this.evalTimes=0,this.oldVal=this.newVal=this.getTempResult().value,this.once&&!this.readonly&&(this.fn=null)},t.prototype.compute=function(){if(this.readonly)return this.getTempResult().value;for(var t={},e=void 0,n=0;n<this.required.length;n++){e=this.required[n];var r=this.owner.__computedObservers[e];r.everEvaluated||r.eval(),t[e]=r.newVal}return this.fn.call(this.owner,t)},t.prototype.eval=function(t){this.everEvaluated=!0,this._evaluating=!0,this.evalTimes++;var e=!!arguments.length,n=e?t:this.compute(),r=void 0,i=void 0,a=e||!(0,s.isEqual)(this.newVal,n);this.newVal=n,e?(r=!0,i=!0):a?(r=!0,this.readonly||(i=!0)):this.readonly||(r=!0),i&&(0,o.setValueOfPath)(this.owner.__tempComputedResult,this.name,n),r&&this.triggerRootObserverChildrenDirtyCheck(),a&&this.observers.forEach(f),this._evaluating=!1},t.prototype.getTempResult=function(){return(0,o.getValueOfPath)(this.owner.__tempComputedResult,this.name)},t.prototype.triggerRootObserverChildrenDirtyCheck=function(){this.isRootObserver||this.rootObserver.checkDirty();for(var t=void 0,e=0;e<this.rootObserver.children.length;e++)(t=this.rootObserver.children[e])!==this&&t.checkDirty()},r(t,[{key:\"changed\",get:function(){return!(0,s.isEqual)(this.oldVal,this.newVal)}},{key:\"dirty\",get:function(){return!(0,s.isEqual)(this.newVal,this.getTempResult().value)}},{key:\"isAlive\",get:function(){return this.getTempResult().key}},{key:\"once\",get:function(){return!this.required.length}},{key:\"readonly\",get:function(){return!this.fn}},{key:\"rootObserver\",get:function(){return this.isRootObserver?this:this.owner.__computedObservers[this.rootPath]}}]),t}();function p(t){for(var e=0;t.length;)if(t.shift().eval(),++e>h)throw new u.default(\"The computing calls exceed \"+h+\".\")}function d(t,e,n){var r=t.__computedObservers,i=e.name,a=e.require,o=void 0===a?[]:a,u=e.fn,s=e.keen,c=r[i];if(c){if(u){c.fn=u,c.required=o,c.keen=s;for(var h=0;h<o.length;h++)d(t,{name:o[h]},c)}}else{if(!(c=r[i]=new l(t,i,o,u,s)).isRootObserver)d(t,{name:c.rootPath}).addChildObserver(c);for(var f=0;f<o.length;f++)d(t,{name:o[f]},c)}return n&&(c.addObserver(n),n.addWatching(c),n.keen&&c.addDirtyObserver(n)),c}function v(t,e){return!!t&&t.hasOwnProperty((0,a.default)(e)[0].key)}e.calculateInitialComputedValues=function(t){var e=t.__computedObservers,n=t.__computingQueue,r=t.__tempComputedResult;Object.assign(r,t.data);var i=void 0,a=void 0;for(i in e)(a=e[i]).readonly?a.eval():(a.watchings.forEach(f),a.addToQueue());if(n.length)return p(n),function(t){var e={},n=void 0,r=void 0;for(r in t)!(n=t[r]).readonly&&n.isAlive&&n.changed&&(e[r]=n.newVal),n.clean();return Object.keys(e).length?e:null}(e)},e.constructComputedFeature=function(t,e){t.__computedObservers={},t.__computingQueue=[],t.__tempComputedResult={};for(var n=function(t,e){var n=[],r=void 0,a=void 0;for(r in t)if(a=t[r],!v(e,r=(0,i.formatPath)(r)))if((0,s.isArray)(a))!function(){var t=a,e=t[0],o=t[1],u=t[2];(0,s.isString)(e)&&(e=[e]),(0,s.isArray)(e)||(e=[]),e=e.map(function(t){return(0,i.formatPath)(t)});var c=(0,s.isFunction)(o);n.push({name:r,require:e,fn:function(t){var n=e.map(function(e){return t[e]});return c?o.apply(this,n):n.length>1?n:n[0]},keen:u})}();else if((0,s.isObject)(a)){var o=a,u=o.require,c=o.fn,h=o.keen;(0,s.isFunction)(c)&&n.push({name:r,require:(u||[]).map(function(t){return(0,i.formatPath)(t)}),fn:c,keen:h})}else(0,s.isFunction)(a)?n.push({name:r,require:[],fn:a}):(0,s.isString)(a)&&function(){var t=(0,i.formatPath)(a);n.push({name:r,require:[t],fn:function(e){return e[t]}})}();return n}(e,t.__props),r=0;r<n.length;r++)d(t,n[r]);return t},e.evaluateComputedResult=function(t,e){var n=t.__computedObservers,r=t.__computingQueue,u=t.__tempComputedResult;for(var s in e){var c=(0,a.default)(s),h=e[s],f=n[s=(0,i.compactPath)((0,i.composePath)(c))]||n[c[0].key];f?f.name===s?f.eval(h):((0,o.setValueOfPath)(u,s,h),f.checkDirty(),f.triggerRootObserverChildrenDirtyCheck()):(0,o.setValueOfPath)(u,s,h)}p(r)},e.isPropPath=v},function(t,e,n){e.__esModule=!0,e.compactPath=e.composePath=void 0,e.default=g,e.formatPath=function(t){if(\"string\"==typeof t)return y(_(g(t)));throw new r.default(\"The path of data is not a string.\")};var r=function(t){return t&&t.__esModule?t:{default:t}}(n(4));function i(t,e){var n=void 0;switch(t){case 0:n=\"There should be digits inside [] in the path string\";break;case 1:n=\"The path string should not start with []\";break;case 2:n=\"The path string should not be empty\";break;default:n=\"Unknown error occurred when parsing path\"}return new r.default(n+\": \"+e)}var a=function(t){return!/^[^\\[]*\\]/.test(t)},o=function(t){return!t.startsWith(\"[\")},u=function(t){return!/(.+)\\[[^\\]]+$/g.test(t)},s=function(t){return!/\\[\\]/.test(t)},c=function(t){return\"\"!==t},h=function(t){return t.replace(/\\.+/g,\".\")},f=function(t){return/^\\.*(.*?)\\.*$/g.exec(t)[1]},l=function(t){return t.replace(/\\[[\\[\\.\\d]*$/g,\"\")},p=function(t){return t.replace(/\\s+/g,\" \")},d=function(t){return(t.match(/\\]/g)||[]).length};function v(t){var e=f(t).split(\".\"),n=[],r=void 0,i=void 0,a=void 0,o=void 0;for(a=0;a<e.length;a++){for(r=e[a],i=d(r),o=0;o<i;o++)n.push({type:1,key:0});(r=p(r.replace(/\\]/g,\"\")))&&n.push({type:0,key:r})}return n}function g(t){return function t(e){var n=[];if(e){var r=e.startsWith(\"[\"),a=/^(\\[[^\\]]*\\])|([^\\[]+)/g.exec(e)[r?1:2],o=[];if(a.length<e.length&&(o=t(e.slice(a.length))),r){var u=/^\\[([\\d\\.\\[]+)\\]/g.exec(a);if(!u)throw i(0,e);var s=(u=u[1]).length+2;if(!(u=u.replace(/\\.|\\[/g,\"\")))throw i(0,e);if(u*=1,isNaN(u))throw i(0,e);n.push({type:1,key:u}),s<a.length&&(n=n.concat(v(a.slice(s))))}else n=v(a);return n.concat(o)}return n}(function(t){t=[h,p,f,l].reduce(function(t,e){return e(t)},t);for(var e=[a,o,u,s,c],n=0;n<e.length;n++)if(!e[n](t))throw i(4===n?2:1===n?1:0,t);return t}(t))}var _=e.composePath=function(t){return t.map(function(t){return 0===t.type?t.key:\"[\"+t.key+\"]\"}).join(\".\")},y=e.compactPath=function(t){return t.replace(/\\.\\[/g,\"[\").replace(/\\]\\./g,\"]\")}},function(t,e,n){e.__esModule=!0;var r=function(t){function e(){!function(t,e){if(!(t instanceof e))throw new TypeError(\"Cannot call a class as a function\")}(this,e);for(var n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];var a=function(t,e){if(!t)throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");return!e||\"object\"!=typeof e&&\"function\"!=typeof e?t:e}(this,t.call.apply(t,[this].concat(r)));return a.name=e.name,a}return function(t,e){if(\"function\"!=typeof e&&null!==e)throw new TypeError(\"Super expression must either be null or a function, not \"+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,t),e}(Error);e.default=r},function(t,e,n){e.__esModule=!0,e.getValueOfPath=function(t,e){if(e+=\"\",t.hasOwnProperty(e))return{key:!0,value:t[e],path:e};var n=(0,i.default)(e);e=(0,r.compactPath)((0,r.composePath)(n));var o=void 0,u=void 0,s=void 0;for(u=0;u<n.length;u++){if(s=n[u],!(0,a.isObject)(t)||!t.hasOwnProperty(s.key))return{key:!1,path:e};o=t[s.key],t=o}return{key:!0,value:o,path:e}},e.setValueOfPath=function(t,e,n){for(var r=(0,i.default)(e+\"\"),a=void 0,u=void 0,s=0;s<r.length;s++){var c=r[s],h=c.key,f=c.type;o(t)!==f&&(t=a[u]=1===f?[]:{}),t=(a=t)[h],u=h}a[u]=n};var r=n(3),i=function(t){return t&&t.__esModule?t:{default:t}}(r),a=n(6);var o=function(t){return(0,a.isArray)(t)?1:(0,a.isObject)(t)?0:-1}},function(t,e,n){e.__esModule=!0;var r=\"function\"==typeof Symbol&&\"symbol\"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&\"function\"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?\"symbol\":typeof t},i=(e.isObject=function(t){return null!==t&&\"object\"===(void 0===t?\"undefined\":r(t))},e.isFunction=function(t){return\"function\"==typeof t},e.isArray=function(t){return t&&t.constructor===Array},e.isString=function(t){return\"string\"==typeof t},function(t){return\"number\"==typeof t&&isNaN(t)});e.isEqual=function(t,e){return t===e||i(t)&&i(e)},e.nextTick=function(t){return setTimeout(t,10)};\"undefined\"!=typeof wx&&wx.nextTick&&(e.nextTick=function(t){return wx.nextTick(t)})},function(t,e,n){e.__esModule=!0;var r=n(2),i=n(5),a=n(3),o=n(6),u=n(8);function s(t,e){if(!e)return t;var n={};for(var i in t)(0,r.isPropPath)(e,i)||(n[i]=t[i]);return n}e.default=function(t,e,n){if((0,o.isObject)(t)){var c=n.ctx,h=n.isPropChange,f=c.__changing;if(c.__changing=!0,f||(c.__data={},c.__tempComputedResult=Object.assign({},c.data)),t=function(t){var e={};for(var n in t)e[(0,a.formatPath)(n)]=t[n];return e}(t),h||(t=s(t,c.__props)),Object.assign(c.__data,t),(0,r.evaluateComputedResult)(c,t),f)return;for(var l in t=s(function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=Object.assign({},n),a=void 0;for(a in n){var o=(0,i.getValueOfPath)(e,a),u=o.key,s=o.value;u&&(r[a]=s)}var c=void 0;for(a in t)!(c=t[a]).readonly&&c.isAlive&&c.changed&&(r[a]=c.newVal);return r}(c.__computedObservers,c.__tempComputedResult,c.__data),c.__props),c.__computedObservers)c.__computedObservers[l].clean();c.__data=null,c.__changing=!1,c.__setData(t,e),(0,u.checkWatchers)(c)}}},function(t,e,n){var r=n(5),i=n(3),a=n(6);t.exports={constructWatchFeature:function(t,e,n){var o=t.__watchers={};if((0,a.isObject)(e)){var u=void 0,s=void 0;for(s in e)u=e[s],(0,a.isFunction)(u)&&(o[s=(0,i.formatPath)(s)]={cb:u,path:s,value:(0,r.getValueOfPath)(n,s).value})}},checkWatchers:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),o=1;o<e;o++)n[o-1]=arguments[o];var u=t.__watchers;if(u){n=n.length?n.map(function(t){return(0,i.formatPath)(t)}):Object.keys(u);var s=void 0,c=void 0,h=function(){s=n[c];var e=u[s],i=e.value,o=(0,r.getValueOfPath)(t.data,s).value;(0,a.isEqual)(i,o)||(e.value=o,setTimeout(function(){return e.cb.call(t,o,i)}))};for(c=0;c<n.length;c++)h()}}}},function(t,e,n){e.__esModule=!0,e.patchComponent=function(t,e){if(t.__patchComponent)return t;var n=!1,s=(e||{}).debug,c=function(e){(e=Object.assign({},e)).properties=function(t){var e=function(e){var r=t[e];e=(0,u.formatPath)(e),((0,a.isFunction)(r)||null===r)&&(r=t[e]={type:r});var o=r,s=o.observer;r.observer=function(t,n,r){var o=this,u=\"string\"==typeof s?this[s]:s;(0,a.isFunction)(u)||(u=null),this.$setData&&this.$setData.__attached?(this.__changedProps||(this.__changedProps={}),this.__changedProps[e]=t,(0,a.nextTick)(function(){o.__changedProps&&((0,i.default)(o.__changedProps,null,{ctx:o,isPropChange:!0}),o.__changedProps=null),u&&u.call(o,t,n,r)})):u&&u.call(this,t,n,r)},n=e};for(var n in t)e(n);return t}(e.properties||{});var c=e,h=c.attached,f=c.created,l=c.watch,p=c.lifetimes,d=c.computed;(0,a.isObject)(p)&&(p.hasOwnProperty(\"attached\")&&(h=p.attached),p.hasOwnProperty(\"created\")&&(f=p.created));var v=function(){this.__props=e.properties,this.$setData||(this.$setData=this.updateData=function(){return this.setData.apply(this,arguments)}),(0,r.constructComputedFeature)(this,d),(0,a.isFunction)(f)&&f.apply(this,arguments)},g=function(){if(!this.$setData||!this.$setData.__attached){this.__setData=this.setData,this.$setData=this.updateData=function(t,e){return(0,i.default)(t,e,{ctx:this})},this.$setData.__attached=!0;var t=(0,r.calculateInitialComputedValues)(this);t&&this.__setData(t),(0,o.constructWatchFeature)(this,l||{},this.data);try{n||(this.setData=this.$setData)}catch(t){n=!0,s&&(console.log(t),console.log(\"using this.$setData instead of this.setData to support watch and computed features.\"))}}(0,a.isFunction)(h)&&h.apply(this,arguments)};return e.lifetimes?(e.lifetimes.attached=g,e.lifetimes.created=v):(e.attached=g,e.created=v),t(e)};return c.__patchComponent=!0,c};var r=n(2),i=function(t){return t&&t.__esModule?t:{default:t}}(n(7)),a=n(6),o=n(8),u=n(3)},function(t,e,n){e.__esModule=!0;var r=function(t,e){var n=[];if(e)for(var r in e)n.push(r+\"=\"+e[r]);return n.length?t+\"?\"+n.join(\"&\"):t},i=/(^[^?]*)/,a=function(t){var e=i.exec(t);return e?e[1]:\"\"};e.patchOnShareAppMessage=function(t,e){if(t.__patchOnShareAppMessage)return t;var n=(e||{}).router,i=function(e){var i=(e=Object.assign({},e)).onShareAppMessage;return\"function\"==typeof i&&(e.onShareAppMessage=function(t){var e=i.call(this,t),o=e||{},u=o.path,s=o.router,c=void 0===s?n:s;return c?(u||(u=r(this.route,this.options)),function(t,e){return t.replace(/^\\//g,\"\")===e.replace(/^\\//g,\"\")}(c,a(u))?e:(u=c+(~c.indexOf(\"?\")?\"&\":\"?\")+\"redirectTo=\"+encodeURIComponent(u),Object.assign({},e,{path:u}))):e}),t(e)};return i.__patchOnShareAppMessage=!0,i},e.patchRouterPage=function(t){if(t.__patchRouterPage)return t;var e=function(e){var n=(e=Object.assign({},e)).onLoad;return e.onLoad=function(t){var e=t.redirectTo;if(e){var r=decodeURIComponent(e);r.startsWith(\"/\")||(r=\"/\"+r),wx.navigateTo({url:r,fail:function(){wx.switchTab({url:a(r)})}})}\"function\"==typeof n&&n.call(this,t)},t(e)};return e.__patchRouterPage=!0,e}}])});"]}